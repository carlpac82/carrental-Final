<!DOCTYPE html>
<html>
<head>
    <title>Vehicle Editor</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <header class="bg-[#009cb6] border-b sticky top-0 z-50">
        <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <a href="/" class="text-white font-semibold hover:underline">‚Üê Back</a>
                <h1 class="text-white text-xl font-bold">Vehicle Names Editor</h1>
            </div>
            <div class="flex items-center gap-4 text-white text-sm">
                <span id="totalVehicles">0</span> vehicles
                <button onclick="downloadAllImages()" class="px-3 py-2 bg-orange-600 hover:bg-orange-700 rounded-lg font-semibold">
                    üì∏ Download Photos
                </button>
                <button onclick="exportConfiguration()" class="px-3 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-semibold">
                    üì§ Export Config
                </button>
                <button onclick="document.getElementById('importFile').click()" class="px-3 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold">
                    üì• Import Config
                </button>
                <input type="file" id="importFile" accept=".json" class="hidden" onchange="importConfiguration(event)">
            </div>
        </div>
    </header>
    
    <main class="mx-auto max-w-7xl px-4 py-6 space-y-6">
        <!-- Abas -->
        <div class="bg-white rounded-lg shadow">
            <div class="border-b">
                <nav class="flex space-x-4 px-4" aria-label="Tabs">
                    <button onclick="switchTab('all')" id="tabAll" 
                            class="tab-button border-b-2 border-[#009cb6] text-[#009cb6] py-3 px-4 font-semibold">
                        All Vehicles
                    </button>
                    <button onclick="switchTab('uncategorized')" id="tabUncategorized" 
                            class="tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-3 px-4">
                        Uncategorized <span id="uncategorizedCount" class="ml-1 bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs"></span>
                    </button>
                </nav>
            </div>
        </div>
        
        <!-- Management Buttons -->
        <div class="bg-gradient-to-r from-blue-50 to-yellow-50 border-2 border-[#009cb6] rounded-lg shadow-lg p-4 mb-4">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-bold text-[#009cb6] mb-1">üìã Category & Group Management</h3>
                    <p class="text-sm text-gray-600">Create and manage vehicle categories and groups</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="showNewCategoryInput()" 
                            class="px-6 py-3 bg-[#009cb6] text-white rounded-lg hover:bg-[#007a8e] font-semibold border-2 border-[#009cb6] shadow-lg transition-all transform hover:scale-105">
                        ‚ûï New Category
                    </button>
                    <button onclick="showNewGroupInput()" 
                            class="px-6 py-3 bg-[#f4ad0f] text-gray-900 rounded-lg hover:bg-[#e39e0e] font-semibold border-2 border-[#f4ad0f] shadow-lg transition-all transform hover:scale-105">
                        ‚ûï New Group
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="bg-white rounded-lg shadow p-4" id="filtersSection">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                <input type="text" id="searchInput" placeholder="üîç Search..." 
                       class="px-4 py-2 border rounded-lg">
                
                <select id="filterBrand" class="px-4 py-2 border rounded-lg">
                    <option value="">All brands</option>
                </select>
                
                <select id="filterCategory" class="px-4 py-2 border rounded-lg">
                    <option value="">All categories</option>
                </select>
                
                <button onclick="loadVehicles()" class="px-4 py-2 bg-[#009cb6] text-white rounded-lg hover:bg-[#007a8e]">
                    üîÑ Reload
                </button>
            </div>
        </div>
        
        <!-- Brand Index for Navigation -->
        <div id="brandsIndex" class="bg-white rounded-lg shadow p-4 hidden">
            <div id="brandsIndexContent" class="flex flex-wrap gap-2">
                <!-- Brand buttons will be inserted here -->
            </div>
        </div>
        
        <!-- Vehicles Table (Grouped by Brand) -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="overflow-x-auto">
                <div id="vehiclesContainer">
                    <!-- Brand-grouped tables will be inserted here -->
                </div>
            </div>
        </div>
    </main>
    
    <!-- Modal para Nova Categoria -->
    <div id="newCategoryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full p-6">
            <h2 class="text-xl font-bold mb-4 text-[#009cb6]">‚ûï Create New Category</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Category Name</label>
                    <input type="text" id="newCategoryName" placeholder="Ex: Compact Premium" 
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-[#009cb6]">
                    <p class="text-xs text-gray-500 mt-1">Use descriptive names like "SUV Auto", "Luxury", etc.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Assign to Group</label>
                    <select id="newCategoryGroup" class="w-full px-3 py-2 border rounded-lg">
                        <option value="">Select existing group...</option>
                        <option value="B1">B1 - Mini 4 Doors</option>
                        <option value="B2">B2 - Mini 5 Doors</option>
                        <option value="D">D - Economy</option>
                        <option value="E1">E1 - Mini Automatic</option>
                        <option value="E2">E2 - Economy Automatic</option>
                        <option value="F">F - SUV</option>
                        <option value="G">G - Premium</option>
                        <option value="J1">J1 - Crossover</option>
                        <option value="J2">J2 - Station Wagon</option>
                        <option value="L1">L1 - SUV Automatic</option>
                        <option value="L2">L2 - Station Wagon Automatic</option>
                        <option value="M1">M1 - 7 Seater</option>
                        <option value="M2">M2 - 7 Seater Automatic</option>
                        <option value="N">N - 9 Seater</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Or create a new group first if needed</p>
                </div>
                <div class="flex gap-3 pt-2">
                    <button onclick="confirmNewCategory()" class="flex-1 px-4 py-2 bg-[#009cb6] text-white rounded-lg hover:bg-[#007a8e] font-semibold">
                        ‚úì Create Category
                    </button>
                    <button onclick="closeNewCategoryModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para Novo Grupo -->
    <div id="newGroupModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full p-6">
            <h2 class="text-xl font-bold mb-4 text-[#009cb6]">‚ûï Create New Group</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Group Code</label>
                    <input type="text" id="newGroupCode" placeholder="Ex: P3" maxlength="3"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-[#009cb6] uppercase font-mono">
                    <p class="text-xs text-gray-500 mt-1">2-3 characters code (B1, D, P3, etc.)</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Group Name</label>
                    <input type="text" id="newGroupName" placeholder="Ex: Premium Plus" 
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-[#009cb6]">
                    <p class="text-xs text-gray-500 mt-1">Descriptive name for the group</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Assign to Category</label>
                    <select id="newGroupCategory" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-[#009cb6]">
                        <option value="">Select a category...</option>
                        <option value="MINI 4 Portas">MINI 4 Portas</option>
                        <option value="MINI 5 Portas">MINI 5 Portas</option>
                        <option value="MINI Auto">MINI Auto</option>
                        <option value="ECONOMY">ECONOMY</option>
                        <option value="ECONOMY Auto">ECONOMY Auto</option>
                        <option value="SUV">SUV</option>
                        <option value="SUV Auto">SUV Auto</option>
                        <option value="Crossover">Crossover</option>
                        <option value="Premium">Premium</option>
                        <option value="Station Wagon">Station Wagon</option>
                        <option value="Station Wagon Auto">Station Wagon Auto</option>
                        <option value="7 Lugares">7 Lugares</option>
                        <option value="7 Lugares Auto">7 Lugares Auto</option>
                        <option value="9 Lugares">9 Lugares</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">This group will be assigned to the selected category</p>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
                    <p class="text-xs text-gray-700">
                        <strong>Examples:</strong><br>
                        ‚Ä¢ B1 - Mini 4 Doors ‚Üí MINI 4 Portas<br>
                        ‚Ä¢ D - Economy ‚Üí ECONOMY<br>
                        ‚Ä¢ P3 - Premium Plus ‚Üí Premium
                    </p>
                </div>
                <div class="flex gap-3 pt-2">
                    <button onclick="confirmNewGroup()" class="flex-1 px-4 py-2 bg-[#f4ad0f] text-gray-900 rounded-lg hover:bg-[#e39e0e] font-semibold">
                        ‚úì Create Group
                    </button>
                    <button onclick="closeNewGroupModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Edi√ß√£o -->
    <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Edit Vehicle</h2>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                </div>
                
                <form class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <label class="block text-sm font-medium mb-1">Original Name (from scraping)</label>
                        <input type="text" id="editOriginalName" readonly 
                               class="w-full px-3 py-2 border rounded-lg bg-gray-100 text-gray-600" />
                        <p class="text-xs text-gray-500 mt-1">This is the name from CarJet (not editable)</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">Edited Name (clean) *</label>
                        <input type="text" id="editCleanName" 
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" 
                               placeholder="Ex: peugeot 3008" />
                        <p class="text-xs text-gray-500 mt-1">This is the name that will be used in the system (always lowercase)</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Brand</label>
                            <input type="text" id="editBrand" 
                                   class="w-full px-3 py-2 border rounded-lg" 
                                   placeholder="Ex: peugeot" />
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Model</label>
                            <input type="text" id="editModel" 
                                   class="w-full px-3 py-2 border rounded-lg" 
                                   placeholder="Ex: 3008" />
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 border-2 border-[#009cb6] rounded-lg p-4 mb-4">
                        <h3 class="text-sm font-bold text-[#009cb6] mb-3 uppercase">üìã Category & Group Management</h3>
                        <p class="text-xs text-gray-600 mb-3">Click the buttons below to create new categories or groups</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label class="block text-sm font-medium">Category</label>
                                <button type="button" onclick="showNewCategoryInput()" 
                                        class="px-3 py-1 text-xs bg-[#009cb6] text-white rounded hover:bg-[#007a8e] font-semibold border-2 border-[#009cb6] transition-all">
                                    ‚ûï New Category
                                </button>
                            </div>
                            <select id="editCategory" class="w-full px-3 py-2 border rounded-lg">
                                <option value="MINI 4 Portas">MINI 4 Portas</option>
                                <option value="MINI 5 Portas">MINI 5 Portas</option>
                                <option value="MINI Auto">MINI Auto</option>
                                <option value="ECONOMY">ECONOMY</option>
                                <option value="ECONOMY Auto">ECONOMY Auto</option>
                                <option value="SUV">SUV</option>
                                <option value="SUV Auto">SUV Auto</option>
                                <option value="Crossover">Crossover</option>
                                <option value="Premium">Premium</option>
                                <option value="Station Wagon">Station Wagon</option>
                                <option value="Station Wagon Auto">Station Wagon Auto</option>
                                <option value="7 Lugares">7 Lugares</option>
                                <option value="7 Lugares Auto">7 Lugares Auto</option>
                                <option value="9 Lugares">9 Lugares</option>
                            </select>
                        </div>
                        
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label class="block text-sm font-medium">Group</label>
                                <button type="button" onclick="showNewGroupInput()" 
                                        class="px-3 py-1 text-xs bg-[#f4ad0f] text-gray-900 rounded hover:bg-[#e39e0e] font-semibold border-2 border-[#f4ad0f] transition-all">
                                    ‚ûï New Group
                                </button>
                            </div>
                            <select id="editGroup" class="w-full px-3 py-2 border rounded-lg">
                                <option value="B1">B1 - Mini 4 Doors</option>
                                <option value="B2">B2 - Mini 5 Doors</option>
                                <option value="D">D - Economy</option>
                                <option value="E1">E1 - Mini Automatic</option>
                                <option value="E2">E2 - Economy Automatic</option>
                                <option value="F">F - SUV</option>
                                <option value="G">G - Premium</option>
                                <option value="J1">J1 - Crossover</option>
                                <option value="J2">J2 - Station Wagon</option>
                                <option value="L1">L1 - SUV Automatic</option>
                                <option value="L2">L2 - Station Wagon Automatic</option>
                                <option value="M1">M1 - 7 Seater</option>
                                <option value="M2">M2 - 7 Seater Automatic</option>
                                <option value="N">N - 9 Seater</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="border-t pt-4">
                        <label class="block text-sm font-medium mb-2">Vehicle Photo</label>
                        
                        <!-- Preview da foto -->
                        <div id="photoPreview" class="mb-3 hidden">
                            <img id="photoPreviewImage" src="" alt="Preview" class="h-32 w-auto rounded border">
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <!-- Upload de ficheiro -->
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Upload File</label>
                                <input type="file" id="photoFile" accept="image/*" 
                                       class="w-full text-sm border rounded-lg p-2">
                            </div>
                            
                            <!-- URL da foto -->
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Or paste URL</label>
                                <div class="flex gap-2">
                                    <input type="url" id="photoUrl" 
                                           placeholder="https://www.carjet.com/cdn/img/..." 
                                           class="flex-1 px-3 py-2 border rounded-lg text-sm">
                                    <button type="button" onclick="downloadPhotoFromUrl()" 
                                            class="px-3 py-2 bg-[#009cb6] text-white rounded-lg hover:bg-[#007a8e] text-sm whitespace-nowrap">
                                        üì• Download
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <p class="text-xs text-gray-500 mt-2">
                            The photo will be saved in the database. Formats: JPG, PNG, WebP
                        </p>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded p-3">
                        <p class="text-sm text-blue-800">
                            üí° <strong>Tip:</strong> The edited name will be used as a key in the VEHICLES dictionary. 
                            Always use lowercase and maintain consistency.
                        </p>
                    </div>
                    
                    <div class="flex gap-3">
                        <button type="button" onclick="saveEdit()" 
                                class="flex-1 px-4 py-2 bg-[#009cb6] text-white rounded-lg hover:bg-[#007a8e]">
                            üíæ Save Changes
                        </button>
                        <button type="button" onclick="closeModal()" 
                                class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                    </div>
                </form>
                
                <div id="codePreview" class="hidden mt-4 border-t pt-4">
                    <label class="block text-sm font-medium mb-2">Generated code:</label>
                    <pre class="bg-gray-900 text-green-400 p-3 rounded text-xs overflow-x-auto"><code id="generatedCode"></code></pre>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Export Modal -->
    <div id="exportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Export VEHICLES</h2>
                    <button onclick="closeExportModal()" class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                </div>
                
                <p class="text-sm text-gray-600 mb-4">
                    Copy this code and replace the VEHICLES dictionary in <code class="bg-gray-100 px-2 py-1 rounded">carjet_direct.py</code>
                </p>
                
                <pre class="bg-gray-900 text-green-400 p-4 rounded text-xs overflow-x-auto max-h-96"><code id="fullExportCode"></code></pre>
                
                <div class="flex gap-3 mt-4">
                    <button onclick="copyExportCode()" 
                            class="flex-1 px-4 py-2 bg-[#f4ad0f] text-white rounded-lg hover:bg-[#e39e0e]">
                        üìã Copy All
                    </button>
                    <button onclick="closeExportModal()" 
                            class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let vehiclesData = [];
        let uncategorizedData = [];
        let editingIndex = -1;
        let currentTab = 'all';
        
        // Mapeamento entre categoria e grupo
        const categoryToGroup = {
            'MINI 4 Portas': 'B1',
            'MINI 5 Portas': 'B2',
            'MINI Auto': 'E1',
            'ECONOMY': 'D',
            'ECONOMY Auto': 'E2',
            'SUV': 'F',
            'SUV Auto': 'L1',
            'Crossover': 'J1',
            'Premium': 'G',
            'Station Wagon': 'J2',
            'Station Wagon Auto': 'L2',
            '7 Lugares': 'M1',
            '7 Lugares Auto': 'M2',
            '9 Lugares': 'N'
        };
        
        async function loadVehicles() {
            try {
                const response = await fetch('/api/vehicles/with-originals');
                const data = await response.json();
                
                if (!data.ok) throw new Error(data.error);
                
                // Processar ve√≠culos
                vehiclesData = Object.entries(data.vehicles).map(([cleanName, vehicleData]) => {
                    // Extrair marca e modelo do nome limpo
                    const parts = cleanName.split(' ');
                    const brand = parts[0] || '';
                    const model = parts.slice(1).join(' ') || '';
                    
                    return {
                        original: vehicleData.original,
                        clean: cleanName,
                        brand: brand,
                        model: model,
                        category: vehicleData.category
                    };
                });
                
                // Atualizar contador
                document.getElementById('totalVehicles').textContent = vehiclesData.length;
                
                // Popular dropdowns
                populateFilters();
                
                // Carregar n√£o categorizados
                await loadUncategorized();
                
                // Renderizar tabela
                renderTable();
                
            } catch (error) {
                alert('Error loading: ' + error.message);
            }
        }
        
        async function loadUncategorized() {
            try {
                const response = await fetch('/api/vehicles/uncategorized');
                const data = await response.json();
                
                if (data.ok) {
                    uncategorizedData = data.uncategorized;
                    document.getElementById('uncategorizedCount').textContent = uncategorizedData.length || '';
                }
            } catch (error) {
                console.error('Erro ao carregar n√£o categorizados:', error);
            }
        }
        
        function switchTab(tab) {
            currentTab = tab;
            
            // Atualizar visual das abas
            document.getElementById('tabAll').className = tab === 'all' 
                ? 'tab-button border-b-2 border-[#009cb6] text-[#009cb6] py-3 px-4 font-semibold'
                : 'tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-3 px-4';
            
            document.getElementById('tabUncategorized').className = tab === 'uncategorized' 
                ? 'tab-button border-b-2 border-[#009cb6] text-[#009cb6] py-3 px-4 font-semibold'
                : 'tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-3 px-4';
            
            // Mostrar/ocultar filtros (n√£o categorizados n√£o precisa de filtros complexos)
            document.getElementById('filtersSection').style.display = tab === 'all' ? 'block' : 'none';
            
            // Renderizar
            renderTable();
        }
        
        function populateFilters() {
            // Marcas √∫nicas
            const brands = [...new Set(vehiclesData.map(v => v.brand))].sort();
            const brandSelect = document.getElementById('filterBrand');
            brandSelect.innerHTML = '<option value="">Todas as marcas</option>';
            brands.forEach(brand => {
                brandSelect.innerHTML += `<option value="${brand}">${brand.charAt(0).toUpperCase() + brand.slice(1)}</option>`;
            });
            
            // Categorias √∫nicas
            const categories = [...new Set(vehiclesData.map(v => v.category))].sort();
            const catSelect = document.getElementById('filterCategory');
            catSelect.innerHTML = '<option value="">Todas as categorias</option>';
            categories.forEach(cat => {
                catSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
        }
        
        function renderTable() {
            let filtered = [];
            
            if (currentTab === 'uncategorized') {
                // Mostrar n√£o categorizados
                const search = document.getElementById('searchInput') ? document.getElementById('searchInput').value.toLowerCase() : '';
                filtered = uncategorizedData.filter(v => {
                    if (search && !v.original.toLowerCase().includes(search) && !v.clean.includes(search)) return false;
                    return true;
                }).map(v => ({
                    original: v.original,
                    clean: v.clean,
                    brand: v.brand,
                    model: v.model,
                    category: v.suggested_category + ' (sugest√£o)',
                    isUncategorized: true
                }));
            } else {
                // Mostrar todos (categorizados)
                const search = document.getElementById('searchInput').value.toLowerCase();
                const brandFilter = document.getElementById('filterBrand').value;
                const catFilter = document.getElementById('filterCategory').value;
                
                filtered = vehiclesData.filter(v => {
                    if (search && !v.original.toLowerCase().includes(search) && !v.clean.includes(search)) return false;
                    if (brandFilter && v.brand !== brandFilter) return false;
                    if (catFilter && v.category !== catFilter) return false;
                    return true;
                });
            }
            
            // Sort by brand, then model
            filtered.sort((a, b) => {
                if (a.brand !== b.brand) return a.brand.localeCompare(b.brand);
                return a.model.localeCompare(b.model);
            });
            
            // Group by brand
            const byBrand = {};
            filtered.forEach(vehicle => {
                if (!byBrand[vehicle.brand]) byBrand[vehicle.brand] = [];
                byBrand[vehicle.brand].push(vehicle);
            });
            
            // Brand index
            const brandsIndex = document.getElementById('brandsIndex');
            const brandsIndexContent = document.getElementById('brandsIndexContent');
            
            if (Object.keys(byBrand).length > 1 && currentTab === 'all') {
                brandsIndex.classList.remove('hidden');
                brandsIndexContent.innerHTML = '';
                Object.keys(byBrand).sort().forEach(brand => {
                    const btn = document.createElement('button');
                    btn.className = 'px-4 py-2 bg-[#009cb6] text-white rounded-lg hover:bg-[#007a8e] capitalize font-semibold transition-all';
                    btn.textContent = `${brand} (${byBrand[brand].length})`;
                    btn.onclick = () => scrollToBrand(brand);
                    brandsIndexContent.appendChild(btn);
                });
            } else {
                brandsIndex.classList.add('hidden');
            }
            
            // Render brand tables
            const container = document.getElementById('vehiclesContainer');
            container.innerHTML = '';
            
            Object.keys(byBrand).sort().forEach(brand => {
                const vehicles = byBrand[brand];
                const brandSection = document.createElement('div');
                brandSection.id = `brand-${brand}`;
                brandSection.className = 'mb-6';
                
                const brandHeader = document.createElement('div');
                brandHeader.className = 'bg-[#009cb6] px-6 py-4 border-b-4 border-[#f4ad0f] cursor-pointer hover:bg-[#007a8e] transition-colors';
                brandHeader.innerHTML = `<h3 class="text-xl font-bold capitalize text-white flex items-center justify-between">
                    <span class="flex items-center gap-3">${brand} <span class="text-sm font-normal bg-[#f4ad0f] text-gray-900 px-3 py-1 rounded-full">${vehicles.length} vehicles</span></span>
                    <span class="toggle-icon text-2xl">‚ñº</span>
                </h3>`;
                brandSection.appendChild(brandHeader);
                
                const table = document.createElement('table');
                table.className = 'min-w-full divide-y divide-gray-200 brand-table';
                table.innerHTML = `
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Photo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Original Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Clean Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Group</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200"></tbody>
                `;
                
                const tbody = table.querySelector('tbody');
                vehicles.forEach(vehicle => {
                    const photoUrl = `/api/vehicles/${encodeURIComponent(vehicle.clean)}/photo?t=${Date.now()}`;
                    const isUncat = vehicle.isUncategorized || false;
                    const bgClass = isUncat ? 'bg-yellow-50 hover:bg-yellow-100' : 'hover:bg-gray-50';
                    
                    // Capitalize clean name (Brand Model)
                    const cleanNameCapitalized = vehicle.clean.split(' ').map(word => 
                        word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                    ).join(' ');
                    
                    // Get group from category
                    const categoryClean = vehicle.category.replace(' (sugest√£o)', '');
                    const group = categoryToGroup[categoryClean] || '‚Äî';
                    const groupBadge = group !== '‚Äî' 
                        ? `<span class="px-2 py-1 text-xs font-mono rounded bg-[#f4ad0f] text-gray-900 font-bold">${group}</span>`
                        : `<span class="text-gray-400">‚Äî</span>`;
                    
                    const badge = isUncat 
                        ? `<span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">${vehicle.category}</span>`
                        : `<span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">${vehicle.category}</span>`;
                    const editBtn = isUncat
                        ? `<button onclick="addToVehicles('${vehicle.clean.replace(/'/g, "\\'")}','${vehicle.category.replace(' (sugest√£o)','')}','${vehicle.brand}','${vehicle.model}')" class="text-green-600 hover:text-green-800 font-semibold">‚ûï Add</button>`
                        : `<button onclick="editVehicle(${vehiclesData.indexOf(vehicle)})" class="text-[#009cb6] hover:text-[#007a8e] font-semibold">‚úèÔ∏è Edit</button>`;
                    
                    const row = document.createElement('tr');
                    row.className = bgClass;
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <img src="${photoUrl}" onerror="this.onerror=null;this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2760%27 height=%2740%27%3E%3Crect width=%2760%27 height=%2740%27 fill=%27%23e5e7eb%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 fill=%27%23999%27 font-size=%2712%27%3Eüöó%3C/text%3E%3C/svg%3E';" alt="${vehicle.clean}" class="h-12 w-auto rounded border shadow-sm">
                        </td>
                        <td class="px-6 py-4"><div class="text-sm text-gray-500">${vehicle.original}</div></td>
                        <td class="px-6 py-4"><div class="text-sm ${isUncat?'text-yellow-600':'text-blue-600'} font-semibold">${cleanNameCapitalized}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap">${groupBadge}</td>
                        <td class="px-6 py-4">${badge}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${editBtn}</td>
                    `;
                    tbody.appendChild(row);
                });
                brandSection.appendChild(table);
                container.appendChild(brandSection);
                
                // Add toggle click handler
                brandHeader.onclick = function(e) {
                    e.stopPropagation();
                    const icon = this.querySelector('.toggle-icon');
                    if (table.style.display === 'none') {
                        table.style.display = '';
                        icon.textContent = '‚ñº';
                    } else {
                        table.style.display = 'none';
                        icon.textContent = '‚ñ∂';
                    }
                };
            });
            
            // Collapse all except first
            const allSections = container.querySelectorAll('[id^="brand-"]');
            allSections.forEach((section, idx) => {
                if (idx > 0) {
                    const tbl = section.querySelector('.brand-table');
                    const icn = section.querySelector('.toggle-icon');
                    if (tbl) {
                        tbl.style.display = 'none';
                        icn.textContent = '‚ñ∂';
                    }
                }
            });
        }
        
        function scrollToBrand(brand) {
            const el = document.getElementById(`brand-${brand}`);
            if (!el) return;
            
            // Expand the table if collapsed
            const table = el.querySelector('.brand-table');
            const icon = el.querySelector('.toggle-icon');
            if (table && table.style.display === 'none') {
                table.style.display = '';
                icon.textContent = '‚ñº';
            }
            
            // Scroll to brand with offset
            setTimeout(() => {
                const headerOffset = 100;
                const elementPosition = el.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                
                window.scrollTo({
                    top: offsetPosition,
                    behavior: 'smooth'
                });
                
                // Highlight with yellow ring
                el.classList.add('ring-4','ring-[#f4ad0f]','shadow-2xl');
                setTimeout(() => {
                    el.classList.remove('ring-4','ring-[#f4ad0f]','shadow-2xl');
                }, 2500);
            }, 100);
        }
        
        function showNewCategoryInput() {
            document.getElementById('newCategoryModal').classList.remove('hidden');
            document.getElementById('newCategoryName').value = '';
            document.getElementById('newCategoryGroup').value = '';
            setTimeout(() => document.getElementById('newCategoryName').focus(), 100);
        }
        
        function closeNewCategoryModal() {
            document.getElementById('newCategoryModal').classList.add('hidden');
        }
        
        function confirmNewCategory() {
            const name = document.getElementById('newCategoryName').value.trim();
            const group = document.getElementById('newCategoryGroup').value;
            
            if (!name) {
                alert('‚ùå Please enter a category name');
                return;
            }
            
            if (!group) {
                alert('‚ùå Please select a group for this category');
                return;
            }
            
            // Add to category select
            const select = document.getElementById('editCategory');
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            option.selected = true;
            select.appendChild(option);
            
            // Add to mapping
            categoryToGroup[name] = group;
            
            // Update group select to match
            document.getElementById('editGroup').value = group;
            
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            successMsg.textContent = `‚úì Category "${name}" created in group ${group}`;
            document.body.appendChild(successMsg);
            setTimeout(() => successMsg.remove(), 3000);
            
            closeNewCategoryModal();
        }
        
        function showNewGroupInput() {
            document.getElementById('newGroupModal').classList.remove('hidden');
            document.getElementById('newGroupCode').value = '';
            document.getElementById('newGroupName').value = '';
            document.getElementById('newGroupCategory').value = '';
            setTimeout(() => document.getElementById('newGroupCode').focus(), 100);
        }
        
        function closeNewGroupModal() {
            document.getElementById('newGroupModal').classList.add('hidden');
        }
        
        function confirmNewGroup() {
            const code = document.getElementById('newGroupCode').value.trim().toUpperCase();
            const name = document.getElementById('newGroupName').value.trim();
            const category = document.getElementById('newGroupCategory').value;
            
            if (!code) {
                alert('‚ùå Please enter a group code (ex: P3)');
                return;
            }
            
            if (!name) {
                alert('‚ùå Please enter a group name');
                return;
            }
            
            if (!category) {
                alert('‚ùå Please select a category to assign this group to');
                return;
            }
            
            // Add to group select
            const groupSelect = document.getElementById('editGroup');
            const option = document.createElement('option');
            option.value = code;
            option.textContent = `${code} - ${name}`;
            option.selected = true;
            groupSelect.appendChild(option);
            
            // Add to newCategoryGroup select too
            const catGroupSelect = document.getElementById('newCategoryGroup');
            const option2 = document.createElement('option');
            option2.value = code;
            option2.textContent = `${code} - ${name}`;
            catGroupSelect.appendChild(option2);
            
            // Assign group to category in mapping
            categoryToGroup[category] = code;
            
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.className = 'fixed top-4 right-4 bg-[#f4ad0f] text-gray-900 px-6 py-3 rounded-lg shadow-lg z-50 font-semibold';
            successMsg.innerHTML = `‚úì Group "${code} - ${name}" created<br><span class="text-sm">Assigned to category: ${category}</span>`;
            document.body.appendChild(successMsg);
            setTimeout(() => successMsg.remove(), 4000);
            
            closeNewGroupModal();
        }
        
        function addToVehicles(cleanName, category, brand, model) {
            // Abrir modal de edi√ß√£o pr√©-preenchido para adicionar ao VEHICLES
            editingIndex = -1; // Novo ve√≠culo
            
            document.getElementById('editOriginalName').value = cleanName + ' (do scraping)';
            document.getElementById('editCleanName').value = cleanName;
            document.getElementById('editBrand').value = brand;
            document.getElementById('editModel').value = model;
            document.getElementById('editCategory').value = category;
            document.getElementById('editGroup').value = categoryToGroup[category] || 'D';
            document.getElementById('photoUrl').value = '';
            document.getElementById('photoFile').value = '';
            document.getElementById('codePreview').classList.add('hidden');
            document.getElementById('photoPreview').classList.add('hidden');
            
            currentVehicleName = cleanName;
            
            document.getElementById('editModal').classList.remove('hidden');
        }
        
        function editVehicle(index) {
            editingIndex = index;
            const vehicle = vehiclesData[index];
            
            document.getElementById('editOriginalName').value = vehicle.original;
            document.getElementById('editCleanName').value = vehicle.clean;
            document.getElementById('editBrand').value = vehicle.brand;
            document.getElementById('editModel').value = vehicle.model;
            document.getElementById('editCategory').value = vehicle.category;
            document.getElementById('editGroup').value = categoryToGroup[vehicle.category] || 'D';
            document.getElementById('photoUrl').value = '';
            document.getElementById('photoFile').value = '';
            document.getElementById('codePreview').classList.add('hidden');
            
            // Carregar foto do ve√≠culo
            loadVehiclePhoto(vehicle.clean);
            
            document.getElementById('editModal').classList.remove('hidden');
        }
        
        function saveEdit() {
            const cleanName = document.getElementById('editCleanName').value.toLowerCase().trim();
            const brand = document.getElementById('editBrand').value.toLowerCase().trim();
            const model = document.getElementById('editModel').value.toLowerCase().trim();
            const category = document.getElementById('editCategory').value;
            const group = document.getElementById('editGroup').value;
            
            if (!cleanName || !category) {
                alert('Fill in the edited name and category!');
                return;
            }
            
            // Atualizar dados
            vehiclesData[editingIndex].clean = cleanName;
            vehiclesData[editingIndex].brand = brand;
            vehiclesData[editingIndex].model = model;
            vehiclesData[editingIndex].category = category;
            vehiclesData[editingIndex].group = group;
            
            // Gerar c√≥digo
            const code = `    '${cleanName}': '${category}',  # Grupo ${group} | ${brand} ${model}`;
            document.getElementById('generatedCode').textContent = code;
            document.getElementById('codePreview').classList.remove('hidden');
            
            // Re-renderizar
            renderTable();
        }
        
        function saveAllChanges() {
            let code = 'VEHICLES = {\n';
            
            // Agrupar por categoria
            const byCategory = {};
            vehiclesData.forEach(v => {
                if (!byCategory[v.category]) byCategory[v.category] = [];
                byCategory[v.category].push(v);
            });
            
            // Gerar c√≥digo organizado
            Object.keys(byCategory).sort().forEach(category => {
                code += `    # ${category}\n`;
                byCategory[category].forEach(v => {
                    code += `    '${v.clean}': '${category}',\n`;
                });
                code += '\n';
            });
            
            code += '}';
            
            document.getElementById('fullExportCode').textContent = code;
            document.getElementById('exportModal').classList.remove('hidden');
        }
        
        function copyExportCode() {
            const code = document.getElementById('fullExportCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('‚úÖ Code copied! Paste it in carjet_direct.py');
            });
        }
        
        function closeModal() {
            document.getElementById('editModal').classList.add('hidden');
        }
        
        function closeExportModal() {
            document.getElementById('exportModal').classList.add('hidden');
        }
        
        // Event listeners
        document.getElementById('searchInput').addEventListener('input', renderTable);
        document.getElementById('filterBrand').addEventListener('change', renderTable);
        document.getElementById('filterCategory').addEventListener('change', renderTable);
        
        // Auto-preencher brand e model quando clean name muda
        document.getElementById('editCleanName').addEventListener('input', (e) => {
            const name = e.target.value.toLowerCase().trim();
            const parts = name.split(' ');
            document.getElementById('editBrand').value = parts[0] || '';
            document.getElementById('editModel').value = parts.slice(1).join(' ') || '';
        });
        
        // Sincronizar grupo quando categoria muda
        document.getElementById('editCategory').addEventListener('change', (e) => {
            const category = e.target.value;
            const group = categoryToGroup[category] || 'D';
            document.getElementById('editGroup').value = group;
        });
        
        // Exportar configura√ß√£o completa
        async function exportConfiguration() {
            try {
                const response = await fetch('/api/export/config');
                
                if (!response.ok) {
                    throw new Error('Erro ao exportar');
                }
                
                // Download do ficheiro
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = response.headers.get('Content-Disposition')?.split('filename=')[1] || 'config.json';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                alert('‚úÖ Configuration exported successfully!\nSave this file for backup.');
            } catch (error) {
                alert('‚ùå Export error: ' + error.message);
            }
        }
        
        // Importar configura√ß√£o
        async function importConfiguration(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/api/import/config', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    alert(`‚úÖ Importa√ß√£o conclu√≠da!\n\n` +
                          `Ve√≠culos: ${data.vehicles_count}\n` +
                          `Suppliers: ${data.suppliers_count}\n` +
                          `Users: ${data.users_imported}\n` +
                          `Fotos: ${data.photos_imported || 0}\n\n` +
                          `${data.instructions}`);
                    
                    // Mostrar c√≥digo para copiar
                    if (data.vehicles_code) {
                        console.log('=== C√ìDIGO PARA VEHICLES ===');
                        console.log(data.vehicles_code);
                        
                        if (data.suppliers_code) {
                            console.log('\n=== C√ìDIGO PARA SUPPLIER_MAP ===');
                            console.log(data.suppliers_code);
                        }
                        
                        // Criar modal com c√≥digo
                        const modal = document.createElement('div');
                        modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
                        modal.innerHTML = `
                            <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                                <div class="p-6">
                                    <h2 class="text-xl font-bold mb-4">Imported Code</h2>
                                    <p class="text-sm mb-4">Copy this code and paste it in <code>carjet_direct.py</code>:</p>
                                    <pre class="bg-gray-900 text-green-400 p-4 rounded text-xs overflow-x-auto mb-4">${data.vehicles_code}${data.suppliers_code || ''}</pre>
                                    <div class="flex gap-3">
                                        <button onclick="navigator.clipboard.writeText(\`${data.vehicles_code}${data.suppliers_code || ''}\`).then(() => alert('Copied!')); this.parentElement.parentElement.parentElement.remove()" 
                                                class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                                            üìã Copy Code
                                        </button>
                                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                                class="px-4 py-2 border rounded hover:bg-gray-50">
                                            Close
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(modal);
                    }
                    
                    // Recarregar dados
                    await loadVehicles();
                } else {
                    alert('‚ùå Erro: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Import error: ' + error.message);
            }
            
            // Limpar input
            event.target.value = '';
        }
        
        // Fun√ß√£o para baixar todas as imagens
        async function downloadAllImages() {
            if (!confirm('üì∏ Download all vehicle photos?\n\nThis may take a few minutes (~115 images).')) {
                return;
            }
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥ Downloading...';
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            
            try {
                const response = await fetch('/api/vehicles/images/download', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    alert(`‚úÖ Download complete!\n\n` +
                          `Downloaded: ${data.downloaded}\n` +
                          `Already existed: ${data.skipped}\n` +
                          `Errors: ${data.errors?.length || 0}\n\n` +
                          `Photos now appear in vehicle cards!`);
                    
                    // Recarregar tabela para mostrar as fotos
                    renderTable();
                } else {
                    alert('‚ùå Error downloading photos: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
        
        // Carregar ao iniciar
        loadVehicles();

        // Fun√ß√µes de gest√£o de fotos
        let currentVehicleName = "";
        
        async function loadVehiclePhoto(vehicleName) {
            currentVehicleName = vehicleName;
            const photoUrl = `/api/vehicles/${encodeURIComponent(vehicleName)}/photo`;
            const preview = document.getElementById("photoPreview");
            const previewImage = document.getElementById("photoPreviewImage");
            
            try {
                const response = await fetch(photoUrl);
                if (response.ok) {
                    previewImage.src = photoUrl + "?t=" + Date.now();
                    preview.classList.remove("hidden");
                } else {
                    preview.classList.add("hidden");
                }
            } catch (error) {
                preview.classList.add("hidden");
            }
        }
        
        async function downloadPhotoFromUrl() {
            const url = document.getElementById("photoUrl").value.trim();
            if (!url) {
                alert("Please paste a valid URL!");
                return;
            }
            
            try {
                const response = await fetch(`/api/vehicles/${encodeURIComponent(currentVehicleName)}/photo/from-url`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ url: url })
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    alert("‚úÖ Photo downloaded and saved successfully!");
                    await loadVehiclePhoto(currentVehicleName);
                    renderTable();
                } else {
                    alert("‚ùå Error: " + data.error);
                }
            } catch (error) {
                alert("‚ùå Error downloading photo: " + error.message);
            }
        }
        
        async function uploadPhotoFile() {
            const fileInput = document.getElementById("photoFile");
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const formData = new FormData();
            formData.append("file", file);
            
            try {
                const response = await fetch(`/api/vehicles/${encodeURIComponent(currentVehicleName)}/photo/upload`, {
                    method: "POST",
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    alert("‚úÖ Photo uploaded successfully!");
                    await loadVehiclePhoto(currentVehicleName);
                    renderTable();
                } else {
                    alert("‚ùå Error: " + data.error);
                }
            } catch (error) {
                alert("‚ùå Error uploading photo: " + error.message);
            }
        }
        
        document.addEventListener("DOMContentLoaded", () => {
            const fileInput = document.getElementById("photoFile");
            if (fileInput) {
                fileInput.addEventListener("change", async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            document.getElementById("photoPreviewImage").src = e.target.result;
                            document.getElementById("photoPreview").classList.remove("hidden");
                        };
                        reader.readAsDataURL(file);
                        await uploadPhotoFile();
                    }
                });
            }
        });

    </script>
</body>
</html>

