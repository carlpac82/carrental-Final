<!DOCTYPE html>
<html>
<head>
    <title>Vehicle Names Editor</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-[#009cb6] border-b sticky top-0 z-50">
        <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between">
            <h1 class="text-white text-xl font-bold">Vehicle Names Editor</h1>
            <div class="flex items-center gap-3 text-white text-sm">
                <span id="totalVehicles">0</span> vehicles
                <button onclick="exportVehicles()" class="p-2 hover:bg-white/10 transition-all" title="Export">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>
    
    <main class="mx-auto max-w-7xl px-4 py-6 space-y-6">
        <!-- Abas -->
        <div class="bg-white rounded-lg shadow">
            <div class="border-b">
                <nav class="flex space-x-4 px-4">
                    <button onclick="switchTab('all')" id="tabAll" 
                            class="border-b-2 border-[#009cb6] text-[#009cb6] py-3 px-4 font-semibold">
                        All Vehicles
                    </button>
                    <button onclick="switchTab('uncategorized')" id="tabUncategorized" 
                            class="border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-3 px-4">
                        Uncategorized <span id="uncategorizedCount" class="ml-1 bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs"></span>
                    </button>
                </nav>
            </div>
        </div>
        
        <!-- Botões de Gestão -->
        <div class="bg-gradient-to-r from-blue-50 to-yellow-50 border-2 border-[#009cb6] rounded-lg shadow-lg p-4">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-bold text-[#009cb6]">Category & Group Management</h3>
                    <p class="text-sm text-gray-600">Create and manage vehicle categories and groups</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="showNewCategoryModal()" 
                            class="px-6 py-3 bg-[#009cb6] text-white rounded-lg hover:bg-[#007a8e] font-semibold">
                        + New Category
                    </button>
                    <button onclick="showNewGroupModal()" 
                            class="px-6 py-3 bg-[#f4ad0f] text-gray-900 rounded-lg hover:bg-[#e39e0e] font-semibold">
                        + New Group
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Filtros -->
        <div class="bg-white rounded-lg shadow p-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                <input type="text" id="searchInput" placeholder="🔍 Search..." 
                       class="px-4 py-2 border rounded-lg" onkeyup="filterVehicles()">
                
                <select id="filterBrand" class="px-4 py-2 border rounded-lg" onchange="filterVehicles()">
                    <option value="">All brands</option>
                </select>
                
                <select id="filterCategory" class="px-4 py-2 border rounded-lg" onchange="filterVehicles()">
                    <option value="">All categories</option>
                </select>
                
                <button onclick="loadVehicles()" class="p-2 text-[#009cb6] hover:bg-gray-100 rounded-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Tabela de Veículos -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="overflow-x-auto">
                <div id="vehiclesContainer">
                    <div class="p-8 text-center text-gray-500">
                        Loading vehicles...
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Modal Nova Categoria -->
    <div id="newCategoryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full p-6">
            <h2 class="text-xl font-bold mb-4 text-[#009cb6]">Create New Category</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Category Name</label>
                    <input type="text" id="newCategoryName" placeholder="Ex: Compact Premium" 
                           class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div class="flex gap-3">
                    <button onclick="saveNewCategory()" class="flex-1 px-4 py-2 bg-[#009cb6] text-white rounded-lg">
                        Create
                    </button>
                    <button onclick="closeNewCategoryModal()" class="px-4 py-2 border rounded-lg">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Novo Grupo -->
    <div id="newGroupModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full p-6">
            <h2 class="text-xl font-bold mb-4 text-[#009cb6]">Create New Group</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Group Code</label>
                    <input type="text" id="newGroupCode" placeholder="Ex: P3" maxlength="3"
                           class="w-full px-3 py-2 border rounded-lg uppercase">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Group Name</label>
                    <input type="text" id="newGroupName" placeholder="Ex: Premium Plus" 
                           class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div class="flex gap-3">
                    <button onclick="saveNewGroup()" class="flex-1 px-4 py-2 bg-[#f4ad0f] text-gray-900 rounded-lg">
                        Create
                    </button>
                    <button onclick="closeNewGroupModal()" class="px-4 py-2 border rounded-lg">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Edição -->
    <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Edit Vehicle</h2>
                    <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700 text-2xl">✕</button>
                </div>
                
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <label class="block text-sm font-medium mb-1">Original Name</label>
                        <input type="text" id="editOriginalName" readonly 
                               class="w-full px-3 py-2 border rounded-lg bg-gray-100" />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">Clean Name *</label>
                        <input type="text" id="editCleanName" 
                               class="w-full px-3 py-2 border rounded-lg" />
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Category</label>
                            <select id="editCategory" class="w-full px-3 py-2 border rounded-lg">
                                <option value="MINI 4 Portas">MINI 4 Portas</option>
                                <option value="MINI 5 Portas">MINI 5 Portas</option>
                                <option value="MINI Auto">MINI Auto</option>
                                <option value="ECONOMY">ECONOMY</option>
                                <option value="ECONOMY Auto">ECONOMY Auto</option>
                                <option value="SUV">SUV</option>
                                <option value="SUV Auto">SUV Auto</option>
                                <option value="Crossover">Crossover</option>
                                <option value="Premium">Premium</option>
                                <option value="7 Lugares">7 Lugares</option>
                                <option value="7 Lugares Auto">7 Lugares Auto</option>
                                <option value="9 Lugares">9 Lugares</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Group</label>
                            <select id="editGroup" class="w-full px-3 py-2 border rounded-lg">
                                <option value="B1">B1 - Mini 4 Doors</option>
                                <option value="B2">B2 - Mini</option>
                                <option value="D">D - Economy</option>
                                <option value="E1">E1 - Mini Auto</option>
                                <option value="E2">E2 - Economy Auto</option>
                                <option value="F">F - SUV</option>
                                <option value="G">G - Premium</option>
                                <option value="J1">J1 - Crossover</option>
                                <option value="L1">L1 - SUV Auto</option>
                                <option value="M1">M1 - 7 Seater</option>
                                <option value="M2">M2 - 7 Seater Auto</option>
                                <option value="N">N - 9 Seater</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="saveEdit()" class="flex-1 px-4 py-2 bg-[#009cb6] text-white rounded-lg">
                            💾 Save
                        </button>
                        <button onclick="closeEditModal()" class="px-4 py-2 border rounded-lg">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let allVehicles = [];
        let uncategorizedVehicles = [];
        let currentTab = 'all';
        let editingVehicle = null;
        
        const categoryToGroup = {
            'MINI 4 Portas': 'B1',
            'MINI 5 Portas': 'B2',
            'MINI Auto': 'E1',
            'ECONOMY': 'D',
            'ECONOMY Auto': 'E2',
            'SUV': 'F',
            'SUV Auto': 'L1',
            'Crossover': 'J1',
            'Premium': 'G',
            '7 Lugares': 'M1',
            '7 Lugares Auto': 'M2',
            '9 Lugares': 'N'
        };
        
        async function loadVehicles() {
            try {
                const response = await fetch('/api/vehicles/with-originals');
                const data = await response.json();
                
                if (!data.ok) throw new Error(data.error);
                
                allVehicles = Object.entries(data.vehicles).map(([clean, info]) => ({
                    clean: clean,
                    original: info.original || clean,
                    category: info.category || 'Unknown',
                    brand: clean.split(' ')[0] || '',
                    model: clean.split(' ').slice(1).join(' ') || ''
                }));
                
                document.getElementById('totalVehicles').textContent = allVehicles.length;
                populateFilters();
                await loadUncategorized();
                renderVehicles();
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading vehicles: ' + error.message);
            }
        }
        
        async function loadUncategorized() {
            try {
                const response = await fetch('/api/vehicles/uncategorized');
                const data = await response.json();
                
                if (data.ok) {
                    uncategorizedVehicles = data.uncategorized || [];
                    document.getElementById('uncategorizedCount').textContent = uncategorizedVehicles.length || '';
                }
            } catch (error) {
                console.error('Error loading uncategorized:', error);
            }
        }
        
        function populateFilters() {
            const brands = [...new Set(allVehicles.map(v => v.brand))].sort();
            const brandSelect = document.getElementById('filterBrand');
            brandSelect.innerHTML = '<option value="">All brands</option>';
            brands.forEach(brand => {
                brandSelect.innerHTML += `<option value="${brand}">${brand.charAt(0).toUpperCase() + brand.slice(1)}</option>`;
            });
            
            const categories = [...new Set(allVehicles.map(v => v.category))].sort();
            const catSelect = document.getElementById('filterCategory');
            catSelect.innerHTML = '<option value="">All categories</option>';
            categories.forEach(cat => {
                catSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
        }
        
        function filterVehicles() {
            renderVehicles();
        }
        
        function renderVehicles() {
            const container = document.getElementById('vehiclesContainer');
            let vehicles = currentTab === 'all' ? allVehicles : uncategorizedVehicles;
            
            // Aplicar filtros
            const search = document.getElementById('searchInput').value.toLowerCase();
            const brandFilter = document.getElementById('filterBrand').value;
            const catFilter = document.getElementById('filterCategory').value;
            
            vehicles = vehicles.filter(v => {
                if (search && !v.clean.includes(search) && !v.category.toLowerCase().includes(search)) return false;
                if (brandFilter && v.brand !== brandFilter) return false;
                if (catFilter && v.category !== catFilter) return false;
                return true;
            });
            
            // Agrupar por marca
            const byBrand = {};
            vehicles.forEach(v => {
                if (!byBrand[v.brand]) byBrand[v.brand] = [];
                byBrand[v.brand].push(v);
            });
            
            // Renderizar
            container.innerHTML = '';
            Object.keys(byBrand).sort().forEach(brand => {
                const brandVehicles = byBrand[brand];
                const brandDiv = document.createElement('div');
                brandDiv.className = 'mb-6';
                brandDiv.innerHTML = `
                    <div class="bg-[#009cb6] px-6 py-4 border-b-4 border-[#f4ad0f]">
                        <h3 class="text-xl font-bold capitalize text-white">${brand} <span class="text-sm font-normal bg-[#f4ad0f] text-gray-900 px-3 py-1 rounded-full">${brandVehicles.length} vehicles</span></h3>
                    </div>
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Original Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Clean Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Group</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${brandVehicles.map(v => {
                                const group = categoryToGroup[v.category] || '—';
                                return `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 text-sm text-gray-500">${v.original}</td>
                                        <td class="px-6 py-4 text-sm font-semibold text-blue-600">${v.clean}</td>
                                        <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-mono rounded bg-[#f4ad0f] text-gray-900 font-bold">${group}</span></td>
                                        <td class="px-6 py-4 text-sm text-gray-500">${v.category}</td>
                                        <td class="px-6 py-4">
                                            <button onclick='editVehicle(${JSON.stringify(v)})' class="text-[#009cb6] hover:text-[#007a8e]">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                                </svg>
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
                container.appendChild(brandDiv);
            });
        }
        
        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('tabAll').className = tab === 'all' 
                ? 'border-b-2 border-[#009cb6] text-[#009cb6] py-3 px-4 font-semibold'
                : 'border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-3 px-4';
            document.getElementById('tabUncategorized').className = tab === 'uncategorized' 
                ? 'border-b-2 border-[#009cb6] text-[#009cb6] py-3 px-4 font-semibold'
                : 'border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-3 px-4';
            renderVehicles();
        }
        
        function editVehicle(vehicle) {
            editingVehicle = vehicle;
            document.getElementById('editOriginalName').value = vehicle.original;
            document.getElementById('editCleanName').value = vehicle.clean;
            document.getElementById('editCategory').value = vehicle.category;
            document.getElementById('editGroup').value = categoryToGroup[vehicle.category] || 'D';
            document.getElementById('editModal').classList.remove('hidden');
        }
        
        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            editingVehicle = null;
        }
        
        async function saveEdit() {
            const cleanName = document.getElementById('editCleanName').value.toLowerCase().trim();
            const category = document.getElementById('editCategory').value;
            
            if (!cleanName || !category) {
                alert('Fill in clean name and category!');
                return;
            }
            
            try {
                const response = await fetch('/api/vehicles/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        original_name: editingVehicle.original,
                        clean_name: cleanName,
                        category: category
                    })
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    alert('✅ Vehicle saved!');
                    closeEditModal();
                    await loadVehicles();
                } else {
                    alert('❌ Error: ' + data.error);
                }
            } catch (error) {
                alert('❌ Error: ' + error.message);
            }
        }
        
        function showNewCategoryModal() {
            document.getElementById('newCategoryModal').classList.remove('hidden');
        }
        
        function closeNewCategoryModal() {
            document.getElementById('newCategoryModal').classList.add('hidden');
        }
        
        function saveNewCategory() {
            const name = document.getElementById('newCategoryName').value.trim();
            if (!name) {
                alert('Enter a category name!');
                return;
            }
            
            const select = document.getElementById('editCategory');
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            select.appendChild(option);
            
            alert(`✅ Category "${name}" created!`);
            closeNewCategoryModal();
        }
        
        function showNewGroupModal() {
            document.getElementById('newGroupModal').classList.remove('hidden');
        }
        
        function closeNewGroupModal() {
            document.getElementById('newGroupModal').classList.add('hidden');
        }
        
        function saveNewGroup() {
            const code = document.getElementById('newGroupCode').value.trim().toUpperCase();
            const name = document.getElementById('newGroupName').value.trim();
            
            if (!code || !name) {
                alert('Fill in code and name!');
                return;
            }
            
            const select = document.getElementById('editGroup');
            const option = document.createElement('option');
            option.value = code;
            option.textContent = `${code} - ${name}`;
            select.appendChild(option);
            
            alert(`✅ Group "${code} - ${name}" created!`);
            closeNewGroupModal();
        }
        
        function exportVehicles() {
            let code = 'VEHICLES = {\n';
            const byCategory = {};
            allVehicles.forEach(v => {
                if (!byCategory[v.category]) byCategory[v.category] = [];
                byCategory[v.category].push(v);
            });
            
            Object.keys(byCategory).sort().forEach(category => {
                code += `    # ${category}\n`;
                byCategory[category].forEach(v => {
                    code += `    '${v.clean}': '${category}',\n`;
                });
                code += '\n';
            });
            code += '}';
            
            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'vehicles_export.py';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Load on start
        window.addEventListener('DOMContentLoaded', loadVehicles);
    </script>
</body>
</html>
